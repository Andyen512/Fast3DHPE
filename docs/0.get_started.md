# Get Started
## Installation
1. clone this repo.
    ```
    git clone https://github.com/Andyen512/Fast3DHPE.git
    ```
2. Install dependencies:

    Install the required Python packages using `requirements.txt`:
    ```bash
    pip install -r requirements.txt
    ```
    For the FinePose component, CLIP is additionally required and can be installed as follows:
    ```bash
    pip install git+https://github.com/openai/CLIP.git
    ```

    **Note:**  
    If you want to evaluate our model on the MPI-INF-3DHP dataset, you also need to install [MATLAB](https://www.mathworks.com/products/matlab-online.html) for running the official evaluation scripts.

## Prepare dataset
See [prepare dataset](1.prepare_dataset.md).

## Get trained model
Pre-trained models will be open-sourced as soon as possible.

## Train
Train a model by
```
CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 python -m torch.distributed.launch --master_port 14622 --nproc_per_node=8 main.py  --cfg ./configs/test_time/h36m_ddhpose.yaml  --phase train --log_to_file
```
- `python -m torch.distributed.launch` [DDP](https://pytorch.org/tutorials/intermediate/ddp_tutorial.html) launch instruction.
- `--nproc_per_node` The number of gpus to use, and it must equal the length of `CUDA_VISIBLE_DEVICES`.
- `--cfgs` The path to config file.
- `--phase` Specified as `train`.
<!-- - `--iter` You can specify a number of iterations or use `restore_hint` in the config file and resume training from there. -->
- `--log_to_file` If specified, the terminal log will be written on disk simultaneously. 

You can run commands in [./misc/train.sh](./misc/train.sh) for training different models.


## Evaluate
You can download our pre-trained models, which are evaluated on Human3.6M (from [here](https://drive.google.com/drive/folders/1P9zbC_VMw_1K4DTTFFglLSN2J1PoI5kd?usp=sharing)) and MPI-INF-3DHP (from [here](https://drive.google.com/drive/folders/1yux7QiLOpHqJXVB9GaVz5A279JunGfuX?usp=sharing)). Put them in the `./checkpoint` directory. 

### Human3.6M

```bash
CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 python -m torch.distributed.launch --master_port 14622 --nproc_per_node=8 main.py  --cfg ./configs/test_time/h36m_ddhpose.yaml  --phase test --log_to_file --evaluate best_epoch.bin
```
- `--phase` Specified as `test`.

You can run commands in [./misc/test.sh](./misc/test.sh) for testing different models.



### MPI-INF-3DHP
To evaluate on MPI-INF-3DHP, please run:

```bash
CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 python -m torch.distributed.launch --master_port 14622 --nproc_per_node=8 main.py  --cfg ./configs/3dhp_ddhposepp.yaml  --phase test --log_to_file --evaluate best_epoch.bin
```
After that, the predicted 3D poses under P-Best, P-Agg, J-Best, J-Agg settings are saved as four files (`.mat`) in `./checkpoint`. To get the MPJPE, AUC, PCK metrics, you can evaluate the predictions by running a Matlab script `./3dhp_test/test_util/mpii_test_predictions_ori_py.m` (you can change 'aggregation_mode' in line 29 to get results under different settings). Then, the evaluation results are saved in `./3dhp_test/test_util/mpii_3dhp_evaluation_sequencewise_ori_{setting name}_t{iteration index}.csv`. You can manually average the three metrics in these files over six sequences to get the final results. An example is shown in `./3dhp_test/test_util/H20_K10/mpii_3dhp_evaluation_sequencewise_ori_J_Best_t10.csv`.



## Warning
- In `DDP` mode, zombie processes may be generated when the program terminates abnormally. You can use this command [sh misc/clean_process.sh](./misc/clean_process.sh) to clear them. 